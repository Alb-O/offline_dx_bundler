# Offline DX Bundler

> [!NOTE] Currently I suspect this crate is only useful for my specific use case in my larger project. If you could potentially find use for it, let me know!

`offline_dx_bundler` contains build-time utilities for fully offline HTML export. The crate was designed for Dioxus WASM sites, but it's likely possible to adapt it for other frameworks as well.

## Highlights

- Generates an offline manifest describing every site page and asset reference in authored content.
- Produces Rust source that mirrors the runtime helpers so offline builds behave exactly the same as the live application.
- Provides utilities for patching the generated `dx serve` output so that it can be opened directly from disk with no HTTP server.

## Getting Started

Add the crate to your build tooling workspace and create an [`OfflineBuildContext`](https://docs.rs/offline_dx_bundler/latest/offline_dx_bundler/struct.OfflineBuildContext.html) with the layout and paths that describe your project:

```rust,no_run
use offline_dx_bundler::{OfflineBuildContext, OfflineBuilder, OfflineProjectLayout};
use offline_dx_bundler::selection::ProgramInclusion;
use std::path::{Path, PathBuf};

struct IncludeAll;
impl ProgramInclusion for IncludeAll {
    fn is_included(&self, _program_id: &str) -> bool {
        true
    }
}

fn main() -> anyhow::Result<()> {
    let layout = OfflineProjectLayout {
        module_assets_dir: "assets",
        module_markdown_file: "index.md",
        program_metadata_file: "program.json",
        prod_dir_name: "prod",
        prod_path_fragment: "/prod/",
        program_asset_literal_prefix: "/content/programs",
        offline_site_root: "site",
        programs_dir_name: "programs",
        offline_bundle_root: "target/offline-html",
        index_html_file: "index.html",
        target_dir: "target",
        offline_manifest_json: "offline_manifest.json",
    };

    let manifest_dir = Path::new("./rs");
    let programs_dir = Path::new("./content/programs");
    let context = OfflineBuildContext::new(
        layout,
        manifest_dir,
        programs_dir,
        programs_dir,
        PathBuf::from("./target/offline-assets"),
    );

    let builder = OfflineBuilder::new(context);
    let selection = IncludeAll;

    let artifacts = builder.build(&selection)?;
    println!("Offline manifest JSON: {}", artifacts.offline_manifest_json);
    Ok(())
}
```

The resulting [`OfflineArtifacts`](https://docs.rs/offline_dx_bundler/latest/offline_dx_bundler/struct.OfflineArtifacts.html) structure contains ready-to-write strings for the generated Rust modules and the offline manifest JSON file.

## Examples

Run `cargo run --example manifest_summary` from the crate directory to see how `OfflineManifestSummary` can be used to inspect an existing manifest JSON file.

## Offline bundle helpers

The `bundle` module contains helpers for patching the static output generated by `dx build`. They expect the manifest generated by `OfflineBuilder` and will update the HTML, JavaScript and CSS artefacts so that the application can be opened directly from disk without a server.
